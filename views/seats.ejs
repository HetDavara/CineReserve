<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Select Seats | CineReserve</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            mint: {
              50: '#f0fdf4',   // Background
              100: '#dcfce7',
              200: '#bbf7d0',   // Borders
              500: '#10b981',   // Primary Accent
              600: '#059669',   // Hover Accent
              900: '#064e3b',   // Deep Text
            }
          },
          animation: {
            'fade-in-up': 'fadeInUp 0.5s ease-out forwards',
          },
          keyframes: {
            fadeInUp: {
              '0%': { opacity: '0', transform: 'translateY(10px)' },
              '100%': { opacity: '1', transform: 'translateY(0)' },
            }
          }
        }
      }
    }
  </script>
</head>

<body class="bg-mint-50 text-mint-900 min-h-screen font-sans p-8">

  <input type="hidden" id="userId" value="<%= user ? user._id : '' %>">

  <div class="max-w-4xl mx-auto text-center">
    <header class="mb-10 animate-fade-in-up">
      <h1 class="text-4xl font-black text-mint-900 mb-2 tracking-tight">Pick Your Spot</h1>
      <p class="text-mint-600 font-medium">Viewing: <span class="font-black underline decoration-mint-200 underline-offset-4"><%= show.movie.title %></span></p>
    </header>

    <div class="w-full max-w-md mx-auto mb-16 animate-fade-in-up" style="animation-delay: 0.1s;">
      <div class="h-1.5 bg-mint-900 rounded-t-full shadow-[0_4px_20px_rgba(16,185,129,0.4)] mb-3"></div>
      <p class="text-center text-[10px] tracking-[0.8em] text-mint-900/40 uppercase font-black">Cinema Screen</p>
    </div>

    <div class="inline-block bg-white p-10 rounded-[3rem] border border-mint-100 shadow-2xl shadow-mint-200/50 mb-12 animate-fade-in-up" style="animation-delay: 0.2s;">
      <% for (let r = 0; r < rows; r++) { 
           const rowChar = String.fromCharCode(65 + r); %>
        <div class="flex gap-3 mb-4 justify-center">
          <span class="w-8 text-mint-200 font-black text-xs self-center text-center"><%= rowChar %></span>
          
          <% for (let c = 1; c <= cols; c++) { 
               const seat = rowChar + c; 
               const isBooked = bookedSeats.includes(seat); %>
            <div 
              class="seat w-10 h-10 flex items-center justify-center rounded-xl text-[10px] font-black transition-all cursor-pointer border-2
              <%= isBooked ? 'bg-slate-100 border-slate-100 text-slate-300 cursor-not-allowed' : 'bg-mint-50 border-mint-100 text-mint-900 hover:border-mint-500 hover:bg-white hover:shadow-lg active:scale-90' %>"
              data-seat="<%= seat %>">
              <%= seat %>
            </div>
          <% } %>
        </div>
      <% } %>
    </div>

    <div class="flex justify-center gap-8 mb-12 animate-fade-in-up" style="animation-delay: 0.3s;">
      <div class="flex items-center gap-2">
        <div class="w-4 h-4 bg-mint-50 border-2 border-mint-100 rounded-md"></div> <span class="text-xs font-bold text-slate-400 uppercase tracking-widest">Available</span>
      </div>
      <div class="flex items-center gap-2">
        <div class="w-4 h-4 bg-mint-900 rounded-md"></div> <span class="text-xs font-bold text-slate-400 uppercase tracking-widest">Selected</span>
      </div>
      <div class="flex items-center gap-2">
        <div class="w-4 h-4 bg-slate-100 rounded-md"></div> <span class="text-xs font-bold text-slate-400 uppercase tracking-widest">Sold Out</span>
      </div>
    </div>

    <div class="space-y-6 animate-fade-in-up" style="animation-delay: 0.4s;">
      <button id="bookBtn" class="px-16 py-5 bg-mint-900 text-white text-xl font-black rounded-full shadow-2xl shadow-mint-900/20 hover:bg-black transition-all transform active:scale-95">
        Confirm Reservation
      </button>
      
      <a href="/" class="block text-mint-500 hover:text-mint-900 font-black text-xs uppercase tracking-[0.2em] transition-colors">
        ‚Üê Change Movie or City
      </a>
    </div>
  </div>

  <script>
    const selectedSeats = [];

    document.querySelectorAll(".seat").forEach(seat => {
      seat.addEventListener("click", () => {
        if (seat.classList.contains("bg-slate-100")) return; // Skip booked

        const seatNo = seat.dataset.seat;
        
        // Toggle Styles: Mint to Forest Green
        seat.classList.toggle("bg-mint-50");
        seat.classList.toggle("border-mint-100");
        seat.classList.toggle("bg-mint-900");
        seat.classList.toggle("text-white");
        seat.classList.toggle("border-mint-900");

        if (selectedSeats.includes(seatNo)) {
          selectedSeats.splice(selectedSeats.indexOf(seatNo), 1);
        } else {
          selectedSeats.push(seatNo);
        }
      });
    });

    document.getElementById("bookBtn").onclick = async () => {
      if (selectedSeats.length === 0) {
        alert("Please choose your preferred seats first.");
        return;
      }

      const userId = document.getElementById("userId").value;
      if (!userId) {
        window.location.href = "/login";
        return;
      }

      const res = await fetch("/api/book", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          showId: "<%= show._id %>",
          userId: userId,
          seats: selectedSeats
        })
      });

      if (res.ok) {
        window.location.href = "/my-bookings";
      } else {
        const data = await res.json();
        alert("Booking failed: " + data.message);
      }
    };
  </script>

</body>
</html>